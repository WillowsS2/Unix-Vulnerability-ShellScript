#!/bin/bash

# log파일로 해당 진단 내용 파일 생성 
. function.sh
TMP1=`SCRIPTNAME`.log
> $TMP1

BAR
CODE [ U-65 ] at 서비스 권한 설정
cat << EOF >> $RESULT
[ 양호 ] : at 명령어 일반사용자 금지 및 at 관련 파일 640 이하인 경우 
[ 취약 ] : at 명령어 일반사용자 사용가능하거나, at 관련 파일 640 이상인 경우
EOF
BAR

# at 명령어 허용/차단 사용자
cat << EOF >> tmp.log
/etc/at.allow
/etc/at.deny
EOF

cat tmp.log | while read VAR
do
    if [ -f $VAR ] ; then
        # 소유자 확인
        CHECK1=`ls -l $VAR | awk '{print $3}'`
        if [ $CHECK1 == 'root' ] ; then
            OK $VAR의 소유자가 root로 설정되어 있습니다.
        else
            WARN $VAR의 소유자가 root로 설정되어 있지 않습니다.
        fi

        # 권한 확인
        # CHECK2=`ls -l $VAR | awk '{print $1}' | cut -c 2-`
        find $VAR -perm -640 -ls | grep -v 'rw-r-----' > $TMP1
        if [ -s $TMP1 ] ; then
            INFO $TMP1 확인해야 합니다.
            WARN $VAR의 권한 설정을 다시해야 합니다.
        else
            OK $VAR의 권한 설정이 올바르게 되어있습니다.
            rm $TMP1
        fi
    else
        INFO $VAR 파일이 존재하지 않습니다.
    fi
done
rm tmp.log

cat $RESULT
echo;